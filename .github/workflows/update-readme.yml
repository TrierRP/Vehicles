name: Update README

on:
  push:
    paths:
    - '**/'
    - '.github/workflows/update-readme.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.MY_GITHUB_TOKEN }}
        
    - name: Update README with directories
      run: |
       echo "Listing directories and subdirectories with hierarchy..."
       # Erstelle eine temporäre Datei für die Verzeichnisse
       touch temp_dirs.md
       find . -type d | cut -c 3- | grep -v '^\.\|_' | while IFS= read -r dir; do
         depth=$(echo "$dir" | tr -cd '/' | wc -c)
         indent=$(printf '  %.0s' $(seq 1 $depth))
         echo "${indent}- [$dir](./$dir/)" >> temp_dirs.md
       done
       # Kombiniere die Teile der README.md mit der temporären Datei
       awk '/<!-- DIR_LIST_START -->/{print;system("cat temp_dirs.md");next} /<!-- DIR_LIST_END -->/{next} 1' README.md > temp_readme.md
       mv temp_readme.md README.md
       rm temp_dirs.md
        
    - name: Commit and push if changed
      run: |
       git diff
       git config --global user.name 'GitHub Actions'
       git config --global user.email 'actions@github.com'
       git add README.md
       git status
       git commit -m "Automatically update README with directory list"
       git remote set-url origin https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/TrierRP/Vehicles.git
       git push origin HEAD:main || echo "No changes to commit/push"
